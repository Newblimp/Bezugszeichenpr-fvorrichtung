name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test-windows:
    name: Test on Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          build
          ~/.cache/ccache
        key: ${{ runner.os }}-cmake-test-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-cmake-test-

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: |
        cmake --build build --config Release --parallel

    - name: Run tests
      run: |
        cd build/tests/Release
        ./unit_tests.exe --gtest_output=xml:test-results.xml

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-windows
        path: build/tests/Release/test-results.xml

  code-coverage:
    name: Code Coverage (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          build
          ~/.cache/ccache
        key: ${{ runner.os }}-cmake-coverage-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-cmake-coverage-

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Install OpenCppCoverage
      run: choco install opencppcoverage

    - name: Add OpenCppCoverage to PATH
      run: echo "C:\Program Files\OpenCppCoverage" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: |
        cmake --build build --config Debug --parallel

    - name: Run tests with coverage
      run: |
        OpenCppCoverage.exe --sources src --excluded_sources tests --export_type cobertura:coverage.xml -- build/tests/Debug/unit_tests.exe

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-windows
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage report artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.xml
# ------------------------------------------------------------------
# NEW JOB: Builds Release EXE, Compresses with UPX, and Publishes
# ------------------------------------------------------------------
  release-nightly:
    name: Release Nightly (Windows)
    # Only run this on the main branch, and only on push (not PRs)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    # Wait for tests to pass before releasing
    needs: [test-windows]
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          build
          ~/.cache/ccache
        key: ${{ runner.os }}-cmake-release-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-cmake-release-

    - name: Cache Chocolatey packages
      uses: actions/cache@v4
      with:
        path: C:\ProgramData\chocolatey\lib
        key: ${{ runner.os }}-choco-upx
        restore-keys: |
          ${{ runner.os }}-choco-

    # Install UPX using Chocolatey (pre-installed on GitHub Windows runners)
    - name: Install UPX
      run: choco install upx -y

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake
      # Ensure we are building for Release
      run: cmake -B build -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Compress with UPX
      # Finds all .exe files in the Release folder and compresses them.
      # Excludes unit_tests.exe if it happens to be there.
      # Note: Adjust 'build/Release/*.exe' if your binary is in 'build/src/Release/'
      run: |
        Get-ChildItem -Path build/Release/*.exe -Exclude "*unit_tests*" | ForEach-Object {
            Write-Host "Compressing $_..."
            upx --best --lzma $_.FullName
        }

    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly
        name: Nightly Build (Latest Main)
        draft: false
        prerelease: true
        # This uploads any .exe found in the Release folder (excluding tests ideally)
        # If your CMake puts the main exe in 'build/src/Release', change this path below.
        files: build/Release/*.exe
