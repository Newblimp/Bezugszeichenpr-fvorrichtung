name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test-linux:
    name: Test on Linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgtk-3-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug

    - name: Build
      run: |
        cmake --build build --parallel

    - name: Run tests
      run: |
        cd build/tests
        ./unit_tests --gtest_output=xml:test-results.xml

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-linux
        path: build/tests/test-results.xml

  test-windows:
    name: Test on Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: |
        cmake --build build --config Release --parallel

    - name: Run tests
      run: |
        cd build/tests/Release
        ./unit_tests.exe --gtest_output=xml:test-results.xml

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-windows
        path: build/tests/Release/test-results.xml

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgtk-3-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          lcov

    - name: Configure CMake with coverage
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"

    - name: Build
      run: |
        cmake --build build --parallel

    - name: Run tests
      run: |
        cd build/tests
        ./unit_tests

    - name: Generate coverage report
      run: |
        lcov --capture --directory build --output-file coverage.info
        lcov --remove coverage.info \
          '/usr/*' \
          '*/build/_deps/*' \
          '*/tests/*' \
          --output-file coverage.info
        lcov --list coverage.info

    - name: Upload coverage to artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.info
# ------------------------------------------------------------------
# NEW JOB: Builds Release EXE, Compresses with UPX, and Publishes
# ------------------------------------------------------------------
  release-nightly:
    name: Release Nightly (Windows)
    # Only run this on the main branch, and only on push (not PRs)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    # Wait for tests to pass before releasing
    needs: [test-windows, test-linux]
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # Install UPX using Chocolatey (pre-installed on GitHub Windows runners)
    - name: Install UPX
      run: choco install upx

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake
      # Ensure we are building for Release
      run: cmake -B build -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Compress with UPX
      # Finds all .exe files in the Release folder and compresses them.
      # Excludes unit_tests.exe if it happens to be there.
      # Note: Adjust 'build/Release/*.exe' if your binary is in 'build/src/Release/'
      run: |
        Get-ChildItem -Path build/Release/*.exe -Exclude "*unit_tests*" | ForEach-Object {
            Write-Host "Compressing $_..."
            upx --best $_.FullName
        }

    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly
        name: Nightly Build (Latest Main)
        draft: false
        prerelease: true
        # This uploads any .exe found in the Release folder (excluding tests ideally)
        # If your CMake puts the main exe in 'build/src/Release', change this path below.
        files: build/Release/*.exe
