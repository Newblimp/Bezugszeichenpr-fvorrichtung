name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test-linux:
    name: Test on Linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgtk-3-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug

    - name: Build
      run: |
        cmake --build build --parallel

    - name: Run tests
      run: |
        cd build/tests
        ./unit_tests --gtest_output=xml:test-results.xml

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-linux
        path: build/tests/test-results.xml

  test-windows:
    name: Test on Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '01f602195983451bc83e72f4214af2cbc495aa94'

    - name: Install PDF dependencies
      run: |
        vcpkg install mupdf:x64-windows tesseract:x64-windows leptonica:x64-windows

    - name: Download Tesseract language data
      run: |
        New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\tessdata"
        Invoke-WebRequest -Uri "https://github.com/tesseract-ocr/tessdata/raw/main/deu.traineddata" -OutFile "$env:GITHUB_WORKSPACE\tessdata\deu.traineddata"
      shell: pwsh

    - name: Configure CMake
      run: |
        $env:TESSDATA_PREFIX = "$env:GITHUB_WORKSPACE\tessdata"
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
      shell: pwsh

    - name: Build
      run: |
        $env:TESSDATA_PREFIX = "$env:GITHUB_WORKSPACE\tessdata"
        cmake --build build --config Release --parallel
      shell: pwsh

    - name: Install UPX
      run: |
        $upxVersion = "4.2.4"
        $upxUrl = "https://github.com/upx/upx/releases/download/v$upxVersion/upx-$upxVersion-win64.zip"
        Invoke-WebRequest -Uri $upxUrl -OutFile upx.zip
        Expand-Archive -Path upx.zip -DestinationPath .
        Move-Item "upx-$upxVersion-win64/upx.exe" upx.exe

    - name: Compress executable with UPX
      run: |
        ./upx.exe --ultra-brute --lzma build/Release/Bezugszeichenvorrichtung.exe

    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: Bezugszeichenvorrichtung-windows-${{ github.sha }}
        path: build/Release/Bezugszeichenvorrichtung.exe

    - name: Run tests
      run: |
        cd build/tests/Release
        ./unit_tests.exe --gtest_output=xml:test-results.xml

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-windows
        path: build/tests/Release/test-results.xml

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgtk-3-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          lcov

    - name: Configure CMake with coverage
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"

    - name: Build
      run: |
        cmake --build build --parallel

    - name: Run tests
      run: |
        cd build/tests
        ./unit_tests

    - name: Generate coverage report
      run: |
        lcov --capture --directory build --output-file coverage.info
        lcov --remove coverage.info \
          '/usr/*' \
          '*/build/_deps/*' \
          '*/tests/*' \
          --output-file coverage.info
        lcov --list coverage.info

    - name: Upload coverage to artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.info
